datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id    String @id @default(cuid())
  email String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  password        Password?
  AccountsOnUsers AccountsOnUsers[]
}

model Password {
  hash String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @unique
}

model Account {
  id              String            @id @default(cuid())
  type            String
  currentBalance  Int               @default(0)
  transactions    Transaction[]
  target          Target?           @relation(fields: [targetId], references: [id])
  targetId        String?           @unique
  AccountsOnUsers AccountsOnUsers[]
}

model Transaction {
  account      Account      @relation(fields: [accountId], references: [id])
  accountId    String
  time         DateTime     @default(now())
  target       Target       @relation(fields: [targetId], references: [id])
  targetId     String
  amount       Int
  revertStatus RevertStatus

  @@id([accountId, time, targetId])
}

model Target {
  id            String        @id @default(cuid())
  name          String
  routingNumber String
  transitNumber String
  account       Account?
  transactions  Transaction[]
}

model AccountsOnUsers {
  user      User        @relation(fields: [userId], references: [id])
  userId    String
  account   Account     @relation(fields: [accountId], references: [id])
  accountId String
  userPerms Permissions

  @@id([userId, accountId])
}

enum RevertStatus {
  NOT_REQUESTED
  REQUESTED
  REVERTED
  LOCKED
}

enum Permissions {
  VIEW
  DEPOSIT
  FULL_ACCESS
  OWNER
}
